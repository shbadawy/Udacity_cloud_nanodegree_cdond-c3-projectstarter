---
  - name: "deployment play." 
    hosts: web
    user: ubuntu
    become: true
    become_method: sudo
    become_user: root  
    gather_facts: false
    vars:
      - env:
        - TYPEORM_CONNECTION: "{{ lookup('env', 'TYPEORM_CONNECTION')}}"
        - TYPEORM_ENTITIES: "{{ lookup('env', 'TYPEORM_ENTITIES')}}"
        - TYPEORM_HOST: "{{ lookup('env', 'TYPEORM_HOST')}}"
        - TYPEORM_PORT: 5432
        - TYPEORM_USERNAME: "{{ lookup('env', 'TYPEORM_USERNAME')}}"
        - TYPEORM_PASSWORD: "{{ lookup('env', 'TYPEORM_PASSWORD')}}"
        - TYPEORM_DATABASE: "{{ lookup('env', 'TYPEORM_DATABASE')}}"
        - TYPEORM_MIGRATIONS: "{{ lookup('env', 'TYPEORM_MIGRATIONS')}}"
        - TYPEORM_MIGRATIONS_DIR: "{{ lookup('env', 'TYPEORM_MIGRATIONS_DIR')}}"
      - ansible_python_interpreter: /usr/bin/python3
      - ansible_host_key_checking: false
      - ansible_stdout_callback: yaml    

    pre_tasks:
      - name: "wait until target is reachable"
        wait_for_connection:
          timeout: 600
      - name: "install python for Ansible."
        become: true
        raw: test -e /usr/bin/python3 || yum -y install python
        changed_when: false
      - name: "print"
        debug:
          msg: "TYPEORM_CONNECTION:{{ lookup('env', 'TYPEORM_CONNECTION')}}\n TYPEORM_ENTITIES:{{ lookup('env', 'TYPEORM_ENTITIES')}}"

    # Get the environment variables from CircleCI and add to the EC2 instance
    environment:
      - TYPEORM_CONNECTION: "{{ lookup('env', 'TYPEORM_CONNECTION')}}"
      - TYPEORM_ENTITIES: "{{ lookup('env', 'TYPEORM_ENTITIES')}}"
      - TYPEORM_HOST: "{{ lookup('env', 'TYPEORM_HOST')}}"
      - TYPEORM_PORT: 5432
      - TYPEORM_USERNAME: "{{ lookup('env', 'TYPEORM_USERNAME')}}"
      - TYPEORM_PASSWORD: "{{ lookup('env', 'TYPEORM_PASSWORD')}}"
      - TYPEORM_DATABASE: "{{ lookup('env', 'TYPEORM_DATABASE')}}"
      - TYPEORM_MIGRATIONS: "{{ lookup('env', 'TYPEORM_MIGRATIONS')}}"
      - TYPEORM_MIGRATIONS_DIR: "{{ lookup('env', 'TYPEORM_MIGRATIONS_DIR')}}"

    roles:
      - deploy    
